{% extends 'base.html' %}
{% block title %}Documents — AI Document Processor{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-6">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Documents</h1>
            <p class="mt-1 text-sm text-gray-500">
                {% if page_obj.paginator.count %}{{ page_obj.paginator.count }} document{{ page_obj.paginator.count|pluralize }}{% else %}No documents found{% endif %}
            </p>
        </div>
        <a href="{% url 'documents:upload_document' %}"
           class="inline-flex items-center justify-center px-4 py-2.5 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors shadow-sm">
            <svg class="w-4 h-4 mr-2 -ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Upload
        </a>
    </div>

    <!-- ── Filters ───────────────────────────────────────────────────── -->
    <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
        <form method="get" class="flex flex-wrap items-end gap-3">
            <div class="flex-1 min-w-[180px]">
                <label for="search" class="block text-xs font-medium text-gray-500 mb-1">Search</label>
                <input type="text" id="search" name="search" value="{{ search_query|default:'' }}"
                       placeholder="Search documents…"
                       class="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500 outline-none transition">
            </div>
            <div class="w-36">
                <label for="status" class="block text-xs font-medium text-gray-500 mb-1">Status</label>
                <select id="status" name="status"
                        class="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500 outline-none transition bg-white">
                    <option value="">All</option>
                    <option value="uploaded"   {% if status_filter == 'uploaded' %}selected{% endif %}>Uploaded</option>
                    <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="completed"  {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="failed"     {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
                </select>
            </div>
            <div class="w-32">
                <label for="file_type" class="block text-xs font-medium text-gray-500 mb-1">Type</label>
                <select id="file_type" name="file_type"
                        class="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500 outline-none transition bg-white">
                    <option value="">All</option>
                    <option value="pdf"  {% if file_type_filter == 'pdf' %}selected{% endif %}>PDF</option>
                    <option value="txt"  {% if file_type_filter == 'txt' %}selected{% endif %}>TXT</option>
                    <option value="docx" {% if file_type_filter == 'docx' %}selected{% endif %}>DOCX</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Filter
                </button>
                {% if search_query or status_filter or file_type_filter %}
                <a href="{% url 'documents:document_list' %}"
                   class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors">
                    Clear
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- ── Documents Table ───────────────────────────────────────────── -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        {% if page_obj %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50/70 border-b border-gray-200">
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Batch</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="doc-tbody">
                    {% for doc in page_obj %}
                    <tr class="hover:bg-gray-50/60 transition-colors" data-doc-id="{{ doc.id }}">
                        <td class="px-6 py-4 font-medium text-gray-900 max-w-xs truncate">
                            <a href="{% url 'documents:document_detail' doc.id %}"
                               class="hover:text-primary-600 transition-colors">{{ doc.title }}</a>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
                                {{ doc.file_type|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-gray-500">{{ doc.file_size|filesizeformat }}</td>
                        <td class="px-6 py-4" id="status-cell-{{ doc.id }}">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold
                                {% if doc.status == 'completed' %}bg-green-100 text-green-800
                                {% elif doc.status == 'processing' %}bg-yellow-100 text-yellow-800
                                {% elif doc.status == 'failed' %}bg-red-100 text-red-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ doc.get_status_display }}
                            </span>
                            {% if doc.status == 'processing' %}
                            <div class="mt-1.5 w-20 bg-gray-200 rounded-full h-1">
                                <div class="bg-yellow-500 h-1 rounded-full transition-all duration-500" style="width:0%" id="progress-{{ doc.id }}"></div>
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-xs">
                            {% if doc.batch %}
                            <a href="{% url 'documents:batch_detail' doc.batch_id %}"
                               class="text-primary-600 hover:underline">{{ doc.batch.title|default:"Untitled"|truncatechars:20 }}</a>
                            {% else %}
                            <span class="text-gray-400">—</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-gray-500 whitespace-nowrap">{{ doc.created_at|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 text-right whitespace-nowrap space-x-2">
                            <a href="{% url 'documents:document_detail' doc.id %}"
                               class="text-primary-600 hover:text-primary-800 font-medium text-xs">View</a>
                            {% if doc.file %}
                            <a href="{{ doc.file.url }}" download="{{ doc.title }}.{{ doc.file_type }}"
                               class="text-gray-500 hover:text-gray-700 font-medium text-xs">Download</a>
                            {% endif %}
                            {% if doc.status == 'failed' %}
                            <button onclick="reprocessDoc('{{ doc.id }}')"
                                    class="text-yellow-600 hover:text-yellow-800 font-medium text-xs">Retry</button>
                            {% elif doc.status == 'processing' %}
                            <button onclick="cancelDoc('{{ doc.id }}')"
                                    class="text-red-600 hover:text-red-800 font-medium text-xs">Cancel</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="flex items-center justify-between px-6 py-3 border-t border-gray-100">
            <p class="text-sm text-gray-500">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</p>
            <div class="flex gap-1">
                {% if page_obj.has_previous %}
                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if file_type_filter %}file_type={{ file_type_filter }}&{% endif %}page={{ page_obj.previous_page_number }}"
                   class="px-3 py-1.5 rounded-lg text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">Prev</a>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <span class="px-3 py-1.5 rounded-lg text-sm font-medium text-white bg-primary-600">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if file_type_filter %}file_type={{ file_type_filter }}&{% endif %}page={{ num }}"
                       class="px-3 py-1.5 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors">{{ num }}</a>
                    {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if file_type_filter %}file_type={{ file_type_filter }}&{% endif %}page={{ page_obj.next_page_number }}"
                   class="px-3 py-1.5 rounded-lg text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="px-6 py-16 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <h3 class="mt-3 text-sm font-semibold text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">
                {% if search_query or status_filter or file_type_filter %}
                    Try adjusting your filters or <a href="{% url 'documents:document_list' %}" class="text-primary-600 hover:underline">clear them</a>.
                {% else %}
                    Upload your first document to get started.
                {% endif %}
            </p>
            <a href="{% url 'documents:upload_document' %}"
               class="mt-5 inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
                Upload Document
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    connectListWebSocket();

    function handleListUpdate(data) {
        if (data.type === 'document_updated') {
            const cell = document.getElementById('status-cell-' + data.document.id);
            if (cell) {
                cell.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold ' +
                    statusClasses(data.document.status) + '">' + capitalize(data.document.status) + '</span>';
            }
            const bar = document.getElementById('progress-' + data.document.id);
            if (bar && data.document.processing) {
                bar.style.width = (data.document.processing.progress || 0) + '%';
            }
        } else if (data.type === 'document_created') {
            location.reload();
        }
    }

    async function reprocessDoc(id) {
        if (!confirm('Reprocess this document?')) return;
        try {
            const res = await fetch('/api/documents/' + id + '/reprocess/', {
                method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
            });
            if (res.ok) { showToast('Reprocessing started', 'success'); setTimeout(() => location.reload(), 800); }
            else { const d = await res.json(); showToast(d.error || 'Failed to reprocess', 'error'); }
        } catch { showToast('Network error', 'error'); }
    }

    async function cancelDoc(id) {
        if (!confirm('Cancel processing for this document?')) return;
        try {
            const res = await fetch('/api/documents/' + id + '/cancel_processing/', {
                method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
            });
            if (res.ok) { showToast('Processing cancelled', 'success'); setTimeout(() => location.reload(), 800); }
            else { const d = await res.json(); showToast(d.error || 'Failed to cancel', 'error'); }
        } catch { showToast('Network error', 'error'); }
    }
</script>
{% endblock %}
